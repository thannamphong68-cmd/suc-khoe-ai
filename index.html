// --- KHỞI TẠO BIẾN CŨ ---
let logs = JSON.parse(localStorage.getItem('healthy_logs')) || [];
let radar, line, audioCtx, oscillator;
let isAudioPlaying = false;

// --- QUẢN LÝ TAB MỚI ---
function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'bg-blue-600'));
    document.getElementById(`tab-${tabId}`).classList.remove('hidden');
    event.currentTarget.classList.add('active', 'bg-blue-600');
    if(isAudioPlaying) toggleAudio(); // Tắt thính lực khi chuyển tab
}

// --- HÀM XỬ LÝ DỮ LIỆU (CŨ + NÂNG CẤP BMR/TDEE) ---
function processData() {
    const w = parseFloat(document.getElementById('weight').value);
    const h = parseFloat(document.getElementById('height').value);
    const age = parseInt(document.getElementById('age').value);
    const g = document.getElementById('gender').value;
    const act = parseFloat(document.getElementById('activity').value);
    const name = document.getElementById('name').value || "Người dùng";

    if(!w || !h || !age) return alert("Hệ thống yêu cầu đủ dữ liệu!");

    // Tính toán chuyên sâu
    const bmi = (w / ((h/100)**2)).toFixed(1);
    const bmr = (g === 'male') ? (10 * w) + (6.25 * h) - (5 * age) + 5 : (10 * w) + (6.25 * h) - (5 * age) - 161;
    const tdee = Math.round(bmr * act);
    const ideal = (g === 'male') ? (h - 100) * 0.9 : (h - 100) * 0.85;
    const bf = Math.abs((1.2 * bmi) + (0.23 * age) - 16.2).toFixed(1);

    // Cập nhật UI Dashboard
    document.getElementById('res-bmi').innerText = bmi;
    document.getElementById('res-bmr').innerText = Math.round(bmr);
    document.getElementById('res-ideal').innerText = ideal.toFixed(0) + "kg";
    document.getElementById('res-fat').innerText = bf;
    document.getElementById('target-cal').innerText = tdee;

    // Biểu đồ & Lịch sử
    updateCharts(bmi, bf, age);
    saveLog(name, bmi);
    showSmartTip(bmi);
    generateAISuggestions(name, age, bmi, g, tdee);
}

// --- BIỂU ĐỒ (CŨ) ---
function updateCharts(bmi, bf, age) {
    radar.data.datasets[0].data = [bmi, 20, age, bf, 25];
    radar.update();
    
    const t = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    line.data.labels.push(t);
    line.data.datasets[0].data.push(bmi);
    if(line.data.labels.length > 8) { line.data.labels.shift(); line.data.datasets[0].data.shift(); }
    line.update();
}

// --- MODULE THỊ LỰC (MỚI) ---
const snellen = [{l:"20/200", s:100}, {l:"20/100", s:70}, {l:"20/70", s:50}, {l:"20/50", s:35}, {l:"20/20", s:12}];
let currentS = 0;
function stepVision(dir) {
    currentS = Math.max(0, Math.min(snellen.length - 1, currentS + dir));
    const stage = snellen[currentS];
    document.getElementById('snellen-char').style.fontSize = stage.s + "px";
    document.getElementById('vision-val').innerText = stage.l;
    document.getElementById('snellen-char').innerText = "EFPTOZ"[Math.floor(Math.random()*6)];
}

// --- MODULE THÍNH LỰC (MỚI) ---
function toggleAudio() {
    const btn = document.getElementById('audio-btn');
    if(!isAudioPlaying) {
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        oscillator = audioCtx.createOscillator();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(document.getElementById('freq-range').value, audioCtx.currentTime);
        const gain = audioCtx.createGain();
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime); // Volume 5% cho an toàn
        oscillator.connect(gain); gain.connect(audioCtx.destination);
        oscillator.start();
        btn.innerHTML = '<i data-lucide="square"></i> Dừng';
        isAudioPlaying = true;
    } else {
        oscillator.stop();
        btn.innerHTML = '<i data-lucide="play"></i> Phát âm thanh';
        isAudioPlaying = false;
    }
    lucide.createIcons();
}

document.getElementById('freq-range').oninput = (e) => {
    document.getElementById('freq-display').innerHTML = `${e.target.value}<span class="text-xl ml-2 opacity-40">Hz</span>`;
    if(isAudioPlaying) oscillator.frequency.setValueAtTime(e.target.value, audioCtx.currentTime);
};

// --- MODULE DINH DƯỠNG (MỚI) ---
let consumed = 0;
function addFood() {
    const name = document.getElementById('food-input').value;
    const cal = parseInt(document.getElementById('cal-input').value);
    const target = parseInt(document.getElementById('target-cal').innerText) || 2000;
    if(!name || !cal) return;

    consumed += cal;
    const item = document.createElement('div');
    item.className = "flex justify-between p-4 bg-white/5 rounded-2xl border border-white/5";
    item.innerHTML = `<span>${name}</span><span class="font-black text-orange-400">${cal} kcal</span>`;
    document.getElementById('diet-log').prepend(item);
    
    document.getElementById('consumed-cal').innerText = consumed;
    document.getElementById('diet-progress').style.width = Math.min(100, (consumed/target)*100) + "%";
}

// --- KHỞI TẠO BIỂU ĐỒ (CŨ) ---
window.onload = function() {
    lucide.createIcons();
    const rCtx = document.getElementById('radarChart').getContext('2d');
    radar = new Chart(rCtx, {
        type: 'radar',
        data: { labels: ['BMI', 'Nước', 'Tuổi', 'Mỡ %', 'Cân đối'], datasets: [{ data: [0,0,0,0,0], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.2)' }] },
        options: { plugins: { legend: { display: false } }, scales: { r: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { display: false } } } }
    });

    const lCtx = document.getElementById('lineChart').getContext('2d');
    line = new Chart(lCtx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'BMI', data: [], borderColor: '#818cf8', tension: 0.4 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
    });
    renderHistory();
};
