<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Health Vision Ultimate - Hệ Thống Chăm Sóc Sức Khỏe Toàn Diện</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .gradient-text { background: linear-gradient(90deg, #2563eb, #7c3aed); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* Intro Animation */
        #intro-overlay {
            position: fixed; inset: 0; z-index: 9999; background: #0f172a;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 1s ease-out;
        }

        #video-container canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        #input_video { transform: scaleX(-1); }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        /* Modal Animation */
        .modal-enter { transform: scale(0.9); opacity: 0; }
        .modal-show { transform: scale(1); opacity: 1; transition: all 0.3s ease; }
    </style>
</head>
<body class="bg-slate-100">

    <div id="intro-overlay">
        <div class="text-center animate-bounce">
            <i class="fas fa-heartbeat text-6-xl text-blue-500 text-6xl mb-4"></i>
            <h1 class="text-white text-4xl font-black tracking-tighter">AI HEALTH VISION</h1>
            <p class="text-blue-300 mt-2 font-light">Kiến tạo cuộc sống khỏe mạnh từ trí tuệ nhân tạo</p>
        </div>
        <div class="mt-10 w-48 h-1 bg-slate-800 rounded-full overflow-hidden">
            <div id="loading-bar" class="h-full bg-blue-500 w-0 transition-all duration-1000"></div>
        </div>
    </div>

    <div class="min-h-screen flex flex-col">
        <nav class="glass border-b border-slate-200 px-6 py-4 flex justify-between items-center sticky top-0 z-50">
            <div class="flex items-center gap-2">
                <i class="fas fa-robot text-blue-600 text-2xl"></i>
                <span class="text-xl font-extrabold gradient-text italic">HEALTH.AI</span>
            </div>
            <div id="ca-dao" class="hidden md:block text-slate-500 italic text-sm font-medium"></div>
            <div class="flex gap-4">
                <button onclick="clearHistory()" class="text-red-500 text-sm font-bold"><i class="fas fa-trash-alt"></i> XÓA LỊCH SỬ</button>
            </div>
        </nav>

        <div class="flex-grow grid grid-cols-1 lg:grid-cols-12 gap-0">
            
            <aside class="lg:col-span-3 bg-white border-r border-slate-200 p-6 overflow-y-auto custom-scroll h-[calc(100vh-80px)]">
                <section class="mb-8">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Thông tin cá nhân</h3>
                    <div class="space-y-4">
                        <input type="text" id="uName" placeholder="Họ và tên" class="w-full p-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="number" id="uAge" placeholder="Tuổi" class="p-3 bg-slate-50 border rounded-xl outline-none">
                            <select id="uGender" class="p-3 bg-slate-50 border rounded-xl outline-none">
                                <option value="Nam">Nam</option>
                                <option value="Nữ">Nữ</option>
                            </select>
                        </div>
                        <input type="number" id="uHeight" placeholder="Chiều cao (cm)" class="w-full p-3 bg-slate-50 border rounded-xl outline-none" oninput="calculateStats()">
                        <input type="number" id="uWeight" placeholder="Cân nặng (kg)" class="w-full p-3 bg-slate-50 border rounded-xl outline-none" oninput="calculateStats()">
                    </div>
                </section>

                <section class="mb-8">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Chỉ số sinh học</h3>
                    <div class="grid grid-cols-1 gap-3">
                        <div class="p-4 bg-blue-50 rounded-2xl border border-blue-100 text-center">
                            <p class="text-xs text-blue-600 font-bold uppercase">BMI</p>
                            <p id="valBMI" class="text-3xl font-black text-blue-900">--</p>
                        </div>
                        <div class="p-4 bg-emerald-50 rounded-2xl border border-emerald-100">
                            <div class="flex justify-between text-xs font-bold text-emerald-600 mb-2">
                                <span>MỠ & NƯỚC (ƯỚC TÍNH)</span>
                            </div>
                            <canvas id="bodyChart"></canvas>
                        </div>
                        <div class="p-4 bg-purple-50 rounded-2xl border border-purple-100 text-center">
                            <p class="text-xs text-purple-600 font-bold">CÂN NẶNG LÝ TƯỞNG</p>
                            <p id="valIdeal" class="text-xl font-black text-purple-900">-- kg</p>
                        </div>
                    </div>
                </section>
            </aside>

            <main class="lg:col-span-6 p-6 flex flex-col items-center">
                <div id="video-container" class="relative w-full aspect-video rounded-3xl shadow-2xl border-8 border-white overflow-hidden bg-slate-900">
                    <video id="input_video" class="hidden"></video>
                    <canvas id="output_canvas"></canvas>
                    
                    <div class="absolute bottom-4 left-4 right-4 flex justify-between items-center glass p-3 rounded-2xl">
                        <div class="flex items-center gap-4 text-slate-700">
                            <i class="fas fa-sun"></i>
                            <input type="range" id="brightness" min="50" max="150" value="100" class="w-24" oninput="updateFilters()">
                            <i class="fas fa-adjust"></i>
                            <input type="range" id="contrast" min="50" max="150" value="100" class="w-24" oninput="updateFilters()">
                        </div>
                        <button onclick="startScanning()" id="btnStart" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-2 rounded-xl font-bold transition-all shadow-lg">
                            BẮT ĐẦU PHÂN TÍCH
                        </button>
                    </div>
                </div>

                <div class="mt-8 w-full">
                    <h3 class="text-sm font-bold text-slate-500 mb-4 flex items-center gap-2">
                        <i class="fas fa-history"></i> LỊCH SỬ GẦN ĐÂY
                    </h3>
                    <div id="history-list" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        </div>
                </div>
            </main>

            <aside class="lg:col-span-3 bg-white border-l border-slate-200 p-6 overflow-y-auto custom-scroll h-[calc(100vh-80px)]">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Phân tích chuyên sâu</h3>
                
                <div id="result-board" class="hidden space-y-6">
                    <div class="bg-slate-900 text-white p-5 rounded-3xl">
                        <h4 class="text-blue-400 font-bold mb-2 uppercase text-xs">Phân tích chung</h4>
                        <p id="resGeneral" class="text-sm leading-relaxed font-light"></p>
                    </div>

                    <div class="flex flex-col gap-4">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center text-orange-600">
                                <i class="fas fa-utensils"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-sm">Gợi ý ăn uống</h4>
                                <p id="resFood" class="text-xs text-slate-500 mt-1"></p>
                            </div>
                        </div>

                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                                <i class="fas fa-running"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-sm">Bài tập đề xuất</h4>
                                <p id="resEx" class="text-xs text-slate-500 mt-1"></p>
                            </div>
                        </div>

                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600">
                                <i class="fas fa-moon"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-sm">Giờ ngủ lý tưởng</h4>
                                <p id="resSleep" class="text-xs text-slate-500 mt-1"></p>
                            </div>
                        </div>
                    </div>

                    <button onclick="downloadPDF()" class="w-full py-4 bg-slate-100 hover:bg-slate-200 rounded-2xl font-bold text-slate-700 transition flex items-center justify-center gap-2">
                        <i class="fas fa-file-download"></i> XUẤT BÁO CÁO (PNG)
                    </button>
                </div>

                <div id="empty-state" class="text-center py-20">
                    <i class="fas fa-chart-line text-4xl text-slate-200 mb-4"></i>
                    <p class="text-slate-400 text-sm">Vui lòng hoàn thành quét camera để xem kết quả chi tiết.</p>
                </div>
            </aside>
        </div>
    </div>

    <script>
        const cadaos = [
            "Muốn cho thân thể bình yên - Hãy ăn rau quả, tập rèn thường xuyên.",
            "Cơm là bản, cá là bè - Sáng thì tập thể dục, tối về ngủ ngon.",
            "Phòng bệnh hơn chữa bệnh.",
            "Có sức khỏe là có tất cả.",
            "Ăn được ngủ được là tiên.",
            "Của thế gian không bằng sức khỏe thân ta."
        ];

        let bodyChart, historyData = JSON.parse(localStorage.getItem('healthHistory') || '[]');

        // Intro & Startup
        window.addEventListener('load', () => {
            const bar = document.getElementById('loading-bar');
            bar.style.width = '100%';
            setTimeout(() => {
                document.getElementById('intro-overlay').style.opacity = '0';
                setTimeout(() => { document.getElementById('intro-overlay').style.display = 'none'; }, 1000);
                displayCaDao();
                renderHistory();
                initChart();
            }, 1500);
        });

        function displayCaDao() {
            const idx = Math.floor(Math.random() * cadaos.length);
            document.getElementById('ca-dao').innerText = "“ " + cadaos[idx] + " ”";
            document.getElementById('ca-dao').classList.remove('hidden');
        }

        function initChart() {
            const ctx = document.getElementById('bodyChart').getContext('2d');
            bodyChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Cơ & Nước', 'Mỡ'],
                    datasets: [{ data: [80, 20], backgroundColor: ['#10b981', '#f59e0b'], borderWidth: 0 }]
                },
                options: { cutout: '70%', plugins: { legend: { display: false } } }
            });
        }

        // BIOLOGIC CALCULATIONS
        function calculateStats() {
            const h = document.getElementById('uHeight').value / 100;
            const w = document.getElementById('uWeight').value;
            if (h > 0 && w > 0) {
                const bmi = (w / (h * h)).toFixed(1);
                document.getElementById('valBMI').innerText = bmi;
                
                // Ideal Weight (Lorentz Formula)
                const ideal = (h * 100 - 100) - ((h * 100 - 150) / 4);
                document.getElementById('valIdeal').innerText = Math.round(ideal);
                
                // Update Chart based on BMI
                const fatEst = bmi > 25 ? 30 : 20;
                bodyChart.data.datasets[0].data = [100 - fatEst, fatEst];
                bodyChart.update();
            }
        }

        // CAMERA & AI
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        let poseAnalyzer;

        async function startScanning() {
            document.getElementById('btnStart').innerText = "ĐANG PHÂN TÍCH...";
            document.getElementById('btnStart').classList.add('animate-pulse');
            
            poseAnalyzer = new Pose({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}` });
            poseAnalyzer.setOptions({ modelComplexity: 1, minDetectionConfidence: 0.5 });
            poseAnalyzer.onResults(onPoseResults);

            const camera = new Camera(videoElement, {
                onFrame: async () => { await poseAnalyzer.send({image: videoElement}); },
                width: 640, height: 480
            });
            camera.start();
        }

        function updateFilters() {
            const b = document.getElementById('brightness').value;
            const c = document.getElementById('contrast').value;
            canvasElement.style.filter = `brightness(${b}%) contrast(${c}%)`;
        }

        function onPoseResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#3b82f6', lineWidth: 4});
                drawLandmarks(canvasCtx, results.poseLandmarks, {color: '#ffffff', fillColor: '#ef4444', lineWidth: 2, radius: 3});
                
                // Sau 3 giây tự động hiện kết quả
                setTimeout(() => showFinalResults(results.poseLandmarks), 3000);
            }
            canvasCtx.restore();
        }

        function showFinalResults(landmarks) {
            const name = document.getElementById('uName').value || "Người dùng";
            const bmi = document.getElementById('valBMI').innerText;
            
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('result-board').classList.remove('hidden');
            document.getElementById('result-board').classList.add('modal-show');

            // AI Logic Insights
            let general = `Chào ${name}, AI nhận thấy cơ thể bạn có độ cân đối ổn định. `;
            let food = "Bổ sung nhiều rau xanh, giảm tinh bột tinh chế.";
            let exercise = "Đi bộ nhanh 30 phút mỗi ngày.";
            let sleep = "22:30 - 06:00 (Đảm bảo ngủ đủ 7-8 tiếng).";

            if (bmi > 25) {
                general += "Bạn đang ở mức thừa cân, cần chú trọng giảm mỡ nội tạng.";
                food = "Chế độ Intermittent Fasting 16:8, cắt giảm đường tuyệt đối.";
                exercise = "Cardio cường độ cao (HIIT) hoặc Bơi lội.";
            } else if (bmi < 18) {
                general += "Bạn hơi gầy, cần tập trung phát triển khối lượng cơ.";
                food = "Tăng cường Protein (ức gà, trứng, đậu) và chất béo tốt.";
                exercise = "Tập tạ (Strength Training) để kích thích cơ bắp.";
            }

            document.getElementById('resGeneral').innerText = general;
            document.getElementById('resFood').innerText = food;
            document.getElementById('resEx').innerText = exercise;
            document.getElementById('resSleep').innerText = sleep;

            saveToHistory({ name, bmi, date: new Date().toLocaleDateString() });
        }

        // HISTORY MANAGEMENT
        function saveToHistory(entry) {
            historyData.unshift(entry);
            if (historyData.length > 6) historyData.pop();
            localStorage.setItem('healthHistory', JSON.stringify(historyData));
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = historyData.map(item => `
                <div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
                    <p class="text-[10px] font-bold text-blue-500 uppercase">${item.date}</p>
                    <p class="font-bold text-slate-800">${item.name}</p>
                    <p class="text-xs text-slate-500">BMI: ${item.bmi}</p>
                </div>
            `).join('');
        }

        function clearHistory() {
            if (confirm("Bạn có chắc muốn xóa sạch lịch sử đo?")) {
                localStorage.removeItem('healthHistory');
                historyData = [];
                renderHistory();
            }
        }

        function downloadPDF() {
            const canvas = document.createElement('canvas');
            canvas.width = 800; canvas.height = 600;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0,0,800,600);
            ctx.fillStyle = '#1e293b';
            ctx.font = 'bold 40px sans-serif';
            ctx.fillText('HEALTH REPORT - ' + document.getElementById('uName').value, 50, 80);
            ctx.font = '20px sans-serif';
            ctx.fillText('BMI: ' + document.getElementById('valBMI').innerText, 50, 150);
            ctx.fillText('Lời khuyên: ' + document.getElementById('resGeneral').innerText.substring(0,60) + '...', 50, 200);
            
            const link = document.createElement('a');
            link.download = 'AI-Health-Report.png';
            link.href = canvas.toDataURL();
            link.click();
        }
        
        window.onload = () => {
            canvasElement.width = 640;
            canvasElement.height = 480;
        };
    </script>
</body>
</html>
